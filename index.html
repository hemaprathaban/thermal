<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>Thermal management  Documentation by hemaprathaban</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">Thermal management  Documentation</h1>
      <h2 class="project-tagline"></h2>
      <a href="https://github.com/hemaprathaban/thermal" class="btn">View on GitHub</a>
      <a href="https://github.com/hemaprathaban/thermal/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/hemaprathaban/thermal/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <p>Thermal management :</p>
<p>The document explains the work carried for Linux thernal drivers for Intel internship.</p>
<p>The generic thermal management uses a concept of cooling states.
The intent of a cooling state is to define thermal modes for supporting devices.
The higher the cooling state, the lower the device/platform temperature would be.
This can be used for both passive and active cooling devices.</p>
<pre><code>• Passive cooling -  does not use a fan or other means of forced-air cooling.  Relies on natural convection cooling.
• Active cooling -   uses a fan directly mounted onto the heat sink for forced-air cooling. 
</code></pre>
<p>Sysfs driver will redirect all the control requests to the appropriate cooling device driver when the user application sets a new cooling state.</p>
<p>It is up to the cooling device driver to  implement the actual cooling control.</p>
<p>Thermal management in user space would imply that all the policy decisions will be taken from user space and the kernel’s job would be only to facilitate those decisions.</p>
<p>Below explains the brief about thermal code how they are used how to register the cooling device</p>
<p>Intel Thermal drivers code flow when you insmod</p>
<ol>
<li>
<p>static int __init init(void) is called, this just calls pci_register_driver() to register intel_pch_thermal_driver.</p>
<pre><code>a.intel_pch_thermal_driver is object of pci_driver structure and it populates
    ▪ all the functions pointer, like probe, remove, shutdown. 
    ▪ name of the pci driver (name)
    ▪ pci_id of the device.	
b.So pci framework will automatically call our probe function when it sees a pci device with the device id we defined. 
</code></pre>
<p>2.intel_pch_thermal_probe() is called by pci framework.</p>
<pre><code>a. it does pci device initialization, (it is understandable by reading)
b. initializes the intel_pch_thermal_device object ptdev.
    ▪ get the memory to operate for register read/write by calling pci_iomap
    ▪ assign particular device operation pch_dev_ops_cpt_ppt or pch_dev_ops_lpt depending on the device (ppt or lpt) in ptdev-&gt;ops.                   
c. register this device as thermal device by calling thermal_zone_device_register()
   we pass tzd_ops object as thermal_zone_device_ops, so the functions mapped in this structure is called when related thermal 
  function is called.
</code></pre>
<p>3.when you call cat /sys/class/thermal/thermal_zone0/temp</p>
<pre><code>a. since its a thermal core sysfs entry, 
      thermal core (thermal_zone_get_temp() in thermal_core.c) calls pch_thermal_get_temp function.
      which inturn calls pch_cpt_ppt_get_temp , which inturn calls pch_thermal_mem_readb to read the register at the offset TSTR_PPT to get the temperature. 
</code></pre>
</li>
<li>
<p>device registers and their bitmasks for each bit or combination of bits are defined in the code. for example</p>
</li>
</ol>
<p>/* Register address for enabling Thermal Sensor*/
#define TSE_PPT	0x01 /* was TSC0 in DPTF */and its bitmasks are,</p>
<p>/* Bit 7: Thermal sensor enable - must be enabled */
#define TSE_PPT_EN	(1 &lt;&lt; 7)  -- set the 7th bit to enable Thermal sensor</p>
<p>/* Bit 6: Analog hysteresis control - must be disabled */
#define TSE_PPT_AHC   (1 &lt;&lt; 6) -- set the 6th bit to disable Analog hysteresis control</p>
<p>/* Bit 5-4: Digital hysteresis amount - must not be 00; 01 - 1C; 10 - 2C;</p>
<ul>
<li>11 - 3C
*/
#define TSE_PPT_DHA   (3 &lt;&lt; 4)  -- set bits 5 and 4 for  Digital hysteresis amount</li>
</ul>
<p>/* Bit 3-2: Sequencer enable and rate - must not be 00 */
#define TSE_PPT_SER   (3 &lt;&lt; 2) -- set bits 3 and 2 for Sequencer enable and rate</p>
<p>/* Bit 1: Thermal sensor output select - 0: catastrophic, 1: hot;</p>
<ul>
<li>recommended is 1
*/
#define TSE_PPT_OUT   (1 &lt;&lt; 1) -- set bit 1 to select the output mode.</li>
</ul>
<p>So to enable thermal sensor, first read whatever the default value in the register
•  value = read(0x01) and
•  write (value|TSE_PPT_EN, 0x01) -- we are ORing the ‘value’ with TSE_PPT_EN and writing to register 0x01.
A sensor can be anything that can sense the thermal or the temperature level.</p>
<p>A cooling device can be anything which can cool the device hardware for example it can be a  fan or heatsink. But a fan or heatsink can be applicable only for laptops or pc. So small devices like mobile phones and tablets don't have a fan or heatsink. In this case a cooling device can be a software like controlling a cpu frequency to reduce the power 2.</p>
<p>As for I understand the generic layer provide thermal zone for each sensor.  These thermal zone can attach any cooling devices depending on trip point. Trip point is basically a particular level of thermal management. Depending on the level a specific cooling device will be chosen. This process is called binding and  binding api is called whenever a cooling device is attached to thermal zone. When the device reaches a particular trip point the relevant cooling device is called  from the thermal Zone. A thermal  zone can attach any number of cooling devices for various trip point levels.</p>
<p>cpufreq: (drivers/cpufreq)</p>
<p><a href="http://doc.opensuse.org/products/draft/SLES/SLES-tuning_sd_draft/cha.tuning.power.html">http://doc.opensuse.org/products/draft/SLES/SLES-tuning_sd_draft/cha.tuning.power.html</a></p>
<p>Generic  CPU cooling support: (drivers/thermal)</p>
<p>config CPU_THERMAL
bool "generic cpu cooling support"
depends on CPU_FREQ
select CPU_FREQ_TABLE
help
This implements the generic cpu cooling mechanism through frequency
reduction. An ACPI version of this already exists
(drivers/acpi/processor_thermal.c).
This will be useful for platforms using the generic thermal interface
and not the ACPI interface.</p>
<h1>
<a id="cpufreq-cooling" class="anchor" href="#cpufreq-cooling" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>cpufreq cooling</h1>
<p>thermal_sys-$(CONFIG_CPU_THERMAL)   	+= cpu_cooling.o</p>
<p>Power Clamp driver: (drivers/thermal)</p>
<p>linux/Documentation/thermal/intel_powerclamp.txt</p>
<p>config INTEL_POWERCLAMP
tristate "Intel PowerClamp idle injection driver"
depends on THERMAL
depends on X86
depends on CPU_SUP_INTEL
help
Enable this to enable Intel PowerClamp idle injection driver. This
enforce idle time which results in more package C-state residency. The
user interface is exposed via generic thermal framework.</p>
<p>obj-$(CONFIG_INTEL_POWERCLAMP)  += intel_powerclamp.o</p>
<p>Here is my commits done for Intel thermal device management
<a href="https://github.com/hemaprathaban/thermal/commits/hema_thermal">commits</a></p>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/hemaprathaban/thermal">Thermal management  Documentation</a> is maintained by <a href="https://github.com/hemaprathaban">hemaprathaban</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

  
  </body>
</html>
